var net = require('net');
var http = require('http');
var fs = require('fs');
var Stream = require('stream').Stream;

var stream = new Stream();
var socket = net.createConnection(5555, '192.168.1.1');
var file = fs.createWriteStream('test.mov');

stream.pipe(file);

var buffer = new Buffer(0);
var frame;


socket.on('data', function(chunk) {
  buffer = Buffer.concat([buffer, chunk]);

  while (true) {
    if (frame) {
      var size = frame.header_size + frame.payload_size;
      if (buffer.length < size) {
        return;
      }

      stream.emit('data', buffer.slice(frame.header_size, frame.header_size + frame.payload_size));

      buffer = buffer.slice(size);
      frame = null;
    }

    if (!frame && buffer.length < 64) {
      return;
    }

    frame = {
      signature: buffer.slice(0, 4).toString('ascii'),
      version: buffer.readUInt8(4),
      video_codec: buffer.readUInt8(5),
      header_size: buffer.readUInt16LE(6),
      payload_size: buffer.readUInt32LE(8),
      encoded_stream_width: buffer.readUInt16LE(12),
      encoded_stream_height: buffer.readUInt16LE(14),
      display_width: buffer.readUInt16LE(16),
      display_height: buffer.readUInt16LE(18),
      frame_number: buffer.readUInt32LE(20),
      timestamp: buffer.readUInt32LE(24),
      total_chunks: buffer.readUInt8(28),
      chunk_index: buffer.readUInt8(29),
      frame_type: buffer.readUInt8(30),
      control: buffer.readUInt8(31),
      stream_byte_position_lw: buffer.readUInt32LE(32),
      stream_byte_position_uw: buffer.readUInt32LE(36),
      stream_id: buffer.readUInt16LE(40),
      total_slices: buffer.readUInt8(42),
      slice_index: buffer.readUInt8(43),
      header1_size: buffer.readUInt8(44),
      header2_size: buffer.readUInt8(45),
      reserved2: buffer.slice(46, 48),
      advertised_size: buffer.readUInt32LE(48),
      reserved3: buffer.slice(52, 64)
    };

    console.log(frame);
  }
});

//http.createServer(function(req, res) {
  //if (req.url === '/') {
    //res.writeHead(200, {'Content-Type': 'text/html'});
    //res.end('<video src="/video" />');
    //return;
  //}

  //if (req.url === '/video') {
    //res.writeHead(200, {'Content-Type': 'video/quicktime'});
    //socket.pipe(res);
    //return;
  //}

  //res.writeHead(404);
  //res.end('404');
//}).listen(8080);
